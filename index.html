<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minist√©rio Infantil - Escalas e Chamada</title>
    <style>
        /* ESTILOS BASE - MANTIDOS E UNIFICADOS DO C√ìDIGO 1 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 30px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1em;
            opacity: 0.95;
        }

        /* NOVO: ESTILOS DE ABAS (TABS) - VOLTOU PARA 1.05em */
        .tabs-nav {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 15px;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 14px 10px;
            border: none;
            background: transparent;
            color: #764ba2;
            font-size: 1.05em; /* RESTAURADO PARA O VALOR ORIGINAL */
            font-weight: 700;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        /* FIM: ESTILOS DE ABAS (TABS) */

        /* ESTILOS DE SE√á√ÉO (ORIGINAIS DOS C√ìDIGOS 1 E 2 + LI√á√ïES) */
        .filter-section, .call-section, .results-section, .room-selection-section, .lesson-section {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            margin-bottom: 20px;
        }

        .filter-title, .form-label {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ESTILOS DO C√ìDIGO 1 (ESCALAS) */
        .date-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }
        
        /* NOVO: Estilo para bot√µes de data na aba Li√ß√µes */
        .date-buttons-lessons { 
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
        }

        .date-btn {
            padding: 16px 10px;
            border: 3px solid #e0e0e0;
            background: white;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #333;
            text-align: center;
            touch-action: manipulation;
            /* Propriedades Flex para Li√ß√µes */
            flex: 1 1 45%; 
            min-width: 120px;
        }

        .date-btn:active {
            transform: scale(0.95);
        }

        .date-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .room-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .room-btn {
            padding: 18px 15px;
            border: 3px solid #e0e0e0;
            background: white;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
            touch-action: manipulation;
        }

        .room-btn:active {
            transform: scale(0.98);
        }

        .room-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .room-icon-btn {
            font-size: 1.8em;
        }

        .room-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
        }

        .room-age {
            font-size: 0.85em;
            opacity: 0.8;
            font-weight: 500;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .btn {
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1.05em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-reset {
            background: #6c757d;
            color: white;
        }

        .btn-export {
            background: #10b981;
            color: white;
        }
        
        /* NOVO ESTILO: BOT√ÉO DE DOWNLOAD */
        .btn-download {
            background: #ffc107; /* Amarelo - Alerta/Download */
            color: #333;
        }

        .results-header {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            line-height: 1.4;
        }

        .schedule-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .schedule-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 18px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }
        
        .schedule-card.santa-ceia-highlight {
            border-left: 5px solid #dc3545;
            background: linear-gradient(135deg, #fcebeb 0%, #f7636f 100%);
        }

        .schedule-card.santa-ceia-highlight .room-name {
            color: #c82333;
        }

        .schedule-card.santa-ceia-highlight .schedule-date {
            background: #dc3545;
            color: white;
        }

        .room-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .room-age-display {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }

        .date-info {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .schedule-date, .lesson-badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.95em;
        }

        .lesson-badge {
            background: #10b981;
        }

        .teacher-search {
            width: 100%;
            padding: 12px;
            margin-bottom: 25px; 
            border: 2px solid #ccc;
            border-radius: 12px;
            font-size: 1em;
            transition: border-color 0.2s ease;
        }
        .teacher-search:focus {
            border-color: #667eea;
            outline: none;
        }

        .teachers-label {
            font-weight: 700;
            color: #555;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .teachers-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .teacher-card {
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            font-weight: 600;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
            border: 2px solid transparent; 
            transition: all 0.2s ease;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #333;
        }

        /* ESTILOS DO C√ìDIGO 2 (CHAMADA) - UNIFICADOS */
        .room-selection-section {
            padding: 15px; 
            margin-bottom: 20px;
        }

        .room-tabs-call { 
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .room-tab-call { 
            flex: 1 1 45%; 
            min-width: 120px;
            padding: 15px 10px;
            border: 3px solid #e0e0e0; 
            background: white; 
            border-radius: 12px; 
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            color: #333; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .room-tab-call.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .room-tab-call:active {
            transform: scale(0.98); 
        }

        .room-name-tab {
            font-size: 1.1em;
        }

        .room-age-tab {
            font-size: 0.8em;
            font-weight: 500;
            opacity: 0.8;
            margin-top: 3px;
        }

        .call-section h2 {
            font-size: 1.2em; 
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .btn-submit {
            background: #10b981;
            padding: 16px 20px; 
            border-radius: 12px; 
            font-size: 1.05em; 
            margin-top: 25px;
        }
        
        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Ajustes de input (RESTAURO DE FONT-SIZE PARA 1.1em) */
        input[type="date"], #teacherName {
            width: 100%;
            padding: 16px; /* Aumenta a altura do campo (preenchimento interno) */
            font-size: 1.1em; /* RESTAURADO PARA O VALOR ORIGINAL */
            border: 2px solid #ccc; 
            border-radius: 12px;
            transition: border-color 0.2s ease;
        }
        
        /* ESTILO PARA A SE√á√ÉO DE ADICIONAR CRIAN√áA */
        .add-kid-section {
            margin-bottom: 20px;
            padding-top: 5px;
        }

        .add-kid-input-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
            margin-bottom: 10px;
        }

        #extraKidName {
            flex: 1;
            padding: 12px;
            border: 2px solid #ccc;
            border-radius: 12px;
            font-size: 1em;
            transition: border-color 0.2s ease;
        }

        #extraKidName:focus {
            border-color: #667eea;
            outline: none;
        }

        .btn-add-kid {
            padding: 0 15px;
            background: #ffc107; 
            color: #333;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-add-kid:active {
            transform: scale(0.98);
        }

        html {
            scroll-behavior: smooth;
        }
        
        button:focus {
            outline: none;
        }
        
        @media (max-width: 360px) {
            h1 {
                font-size: 1.5em;
            }
            
            .date-buttons {
                grid-template-columns: 1fr;
            }
            
            .add-kid-input-group {
                flex-direction: column;
            }
            .btn-add-kid {
                height: 48px;
            }
        }

        /* CSS PARA OS CARDS DE CRIAN√áAS - MANTIDO ORIGINALMENTE */
        .kids-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
            gap: 15px;
            margin-top: 20px;
        }
        
        .kid-card {
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 15px;
            padding: 0; 
            overflow: hidden; 
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 180px; 
            position: relative;
        }
        
        .kid-card.extra {
            background: #fff8e1; 
            border-color: #ffc107; 
        }
        
        .kid-card:active {
            transform: scale(0.98);
        }
        
        .kid-card.present {
            background: #e6f7ef; 
            border-color: #10b981; 
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .kid-photo {
            width: 100%; 
            height: 140px; 
            object-fit: cover; 
            border-radius: 12px 12px 0 0; 
            border-bottom: none; 
            border: none;
            box-shadow: none;
        }
        
        .kid-card.extra .kid-photo {
            background: #ffc107;
            border-color: #ffc107; 
            font-size: 2.5em; 
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: none;
            border-radius: 12px 12px 0 0; 
        }
        
        .kid-card.extra.present .kid-photo {
            background: #10b981;
            border-color: #10b981;
        }

        .kid-name {
            font-size: 1.1em; 
            font-weight: 600;
            color: #333;
            line-height: 1.2;
            padding: 8px 5px; 
            width: 100%; 
            background: white; 
            border-top: 1px solid #eee; 
            border-radius: 0 0 12px 12px; 
        }

        .kid-card.present .kid-name {
            background: #d4ede6; 
            border-color: #10b981;
        }

        .kid-card.extra .kid-name {
            background: #ffe082; 
        }

        .kid-card.extra.present .kid-name {
            background: #d4ede6; 
        }

        #kidsList > .form-label {
            margin-bottom: 15px; 
        }
        
        /* === NOVOS ESTILOS PARA A ABA LI√á√ïES === */
        
        .room-tabs-lessons { 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .lesson-header {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .lesson-status-info {
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.95em;
            color: #6c757d;
        }
        
        .file-upload-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .file-upload-label {
            background: #f1f1f1;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            color: #333;
            border: 2px dashed #ccc;
            transition: all 0.2s ease;
        }
        
        .file-upload-label:hover {
            border-color: #667eea;
            background: #e9ecef;
        }
        
        #pdfFile {
            display: none;
        }
        
        /* ATUALIZADO: 3 bot√µes na grade */
        .lesson-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-upload {
            background: #10b981;
            color: white;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-upload:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* NOVO BOT√ÉO DE DOWNLOAD AQUI (usando .btn-download j√° definido acima) */
        
        .pdf-viewer-container {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            min-height: 400px;
        }
        
        .pdf-viewer {
            width: 100%;
            height: 600px; 
            border: 1px solid #ccc;
            border-radius: 10px;
            background: #f8f9fa;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚úùÔ∏è Minist√©rio Infantil ‚úùÔ∏è</h1>
            <p class="subtitle">Escalas, Chamadas e Li√ß√µes - Novembro 2025</p>
        </header>

        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="escalas" onclick="openTab('escalas', this)">Escalas üìÖ</button>
            <button class="tab-btn" data-tab="chamada" onclick="openTab('chamada', this)">Chamada üîî</button>
            <button class="tab-btn" data-tab="licoes" onclick="openTab('licoes', this)">Li√ß√µes üìñ</button>
        </div>
        
        <div class="tab-content active" id="tab-escalas">
            <div class="filter-section">
                <div class="filter-title">üîé Buscar por Professor</div>
                <input type="text" id="teacherSearchInput" class="teacher-search" placeholder="Digite o nome do professor" oninput="filterByTeacher(this.value)">
                
                <div class="filter-title">üìÖ Escolha a Data</div>
                <div class="date-buttons" id="dateButtons"></div>

                <div class="filter-title">üè† Escolha a Sala</div>
                <div class="room-buttons" id="roomButtons"></div>

                <div class="action-buttons">
                    <button class="btn btn-reset" onclick="resetFilters()">üîÑ Mostrar Todas</button>
                    <button class="btn btn-export" onclick="exportToCSV()">üì• Exportar CSV</button>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    üìã <span id="resultsTitle">Todas as Escalas</span>
                </div>
                <div class="schedule-grid" id="scheduleGrid"></div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-chamada">
            <div class="room-selection-section">
                <div class="form-label">üè† Selecione a Sala (Obrigat√≥rio)</div>
                <div class="room-tabs-call" id="roomTabsCall">
                    </div>
            </div>

            <div class="call-section">
                <h2 class="form-label" id="chamadaTitle">üìùChamada - Selecione a Sala Acima üëÜ</h2>

                <div class="form-group">
                    <label for="teacherName" class="form-label">üßë‚Äçüè´ Nome do Professor(a):</label>
                    <input type="text" id="teacherName" placeholder="Nome da Dupla" required oninput="checkCallFormValidity()">
                </div>

                <div class="form-group">
                    <label for="dateInput" class="form-label">üìÖ Data da Aula:</label>
                    <input type="date" id="dateInput" required onchange="checkCallFormValidity()">
                </div>
                
                <div class="add-kid-section">
                    <div class="form-label">‚ú® Adicionar Crian√ßa/Visitante</div>
                    <div class="add-kid-input-group">
                        <input type="text" id="extraKidName" placeholder="Nome da crian√ßa visitante" disabled>
                        <button class="btn btn-add-kid" onclick="addExtraKid()" disabled>+ Adicionar</button>
                    </div>
                </div>
                <div id="kidsList">
                    <div class="empty-state">
                        Escolha uma sala para come√ßar a lista de chamada.
                    </div>
                </div>

                <button class="btn btn-submit" onclick="submitCall()">‚úÖ Finalizar Chamada</button>
            </div>
        </div>
        
        <div class="tab-content" id="tab-licoes">
            <div class="lesson-section">
                <div class="lesson-header">üõ†Ô∏è Gerenciar Li√ß√µes em PDF</div>
                
                <div class="form-label">üè† Escolha a Sala</div>
                <div class="room-tabs-lessons" id="roomTabsLessons">
                    </div>
                
                <div class="form-label">üìÖ Escolha a Data da Li√ß√£o</div>
                <div class="date-buttons-lessons" id="dateButtonsLessons">
                    </div>
                
                <div class="file-upload-group">
                    <label for="pdfFile" class="file-upload-label" id="fileUploadLabel">
                        üìÅ Escolher Arquivo PDF (Max 5MB)
                    </label>
                    <input type="file" id="pdfFile" accept="application/pdf" onchange="handleFileSelect()">
                    <div class="lesson-status-info" id="fileInfo">Nenhuma li√ß√£o selecionada.</div>
                </div>
                
                <div class="lesson-actions">
                    <button class="btn btn-upload" id="btnUploadLesson" onclick="uploadLesson()" disabled>
                        ‚¨ÜÔ∏è Enviar Li√ß√£o
                    </button>
                    <button class="btn btn-download" id="btnDownloadLesson" onclick="downloadLesson()" disabled>
                        ‚¨áÔ∏è Baixar Li√ß√£o
                    </button>
                    <button class="btn btn-delete" id="btnDeleteLesson" onclick="deleteLesson()" disabled>
                        üóëÔ∏è Excluir
                    </button>
                </div>
                
                <div class="pdf-viewer-container">
                    <div class="lesson-header">üëÅÔ∏è Visualizador da Li√ß√£o</div>
                    <div id="pdfViewerContent">
                        <div class="empty-state" id="lessonsEmptyState">
                            <h3>Selecione uma sala e data acima.</h3>
                            <p>O PDF da li√ß√£o ser√° carregado aqui, se existir.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // *** SEU URL DO APPS SCRIPT DEPLOYED EST√Å AQUI ***
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxEWjkpgOSmFgNLNBIVj_OV73leclt8wk4Swdc_xpWMxCTbw_jw_WNUsD5xcTUimlah5Q/exec';
        // ************************************************
        
        // LIMITE DE ARQUIVO: 5 MB em bytes
        const MAX_FILE_SIZE_BYTES = 5 * 1024 * 1024; 

        // VARI√ÅVEL DE ESTADO PARA O DOWNLOAD
        let currentLessonFileId = null; 
        let currentLessonFileUrl = null; 

        // DADOS COMPARTILHADOS (ESCALAS E CHAMADA)
        const roomsData = {
            ber√ßario: { name: "Ber√ß√°rio", age: "0-2 anos", icon: "üë∂" },
            alfa: { name: "Alfa", age: "3-4 anos", icon: "üß∏" },
            beta: { name: "Beta", age: "5-6 anos", icon: "üé®" },
            gama: { name: "Gama", age: "7-8 anos", icon: "‚öΩ" },
            √¥mega: { name: "√îmega", age: "9-11 anos", icon: "üìö" }
        };
        
        // DADOS FIXOS DAS CRIAN√áAS PARA A CHAMADA VISUAL (Mantidos)
        const kidsData = {
            ber√ßario: [ 
                { id: 1, name: "Maria Eduarda", photo: "m_eduarda.png" },
                { id: 2, name: "Jo√£o Pedro", photo: "j_pedro.png" },
                { id: 3, name: "Sophia R.", photo: "sophia.png" },
                { id: 4, name: "Ben√≠cio L.", photo: "benicio.png" },
                { id: 5, name: "Lara M.", photo: "lara.png" }
            ],
            alfa: [ 
                { id: 6, name: "Alice", photo: "alice_alfa.png" },
                { id: 7, name: "Levi", photo: "levi_alfa.png" },
                { id: 8, name: "Emily", photo: "emily_alfa.png" },
                { id: 9, name: "Arthur", photo: "arthur_alfa.png" },
                { id: 10, name: "Laura", photo: "laura_alfa.png" },
                { id: 11, name: "Ben√≠cio", photo: "benicio_aalfa.png" },
                { id: 12, name: "Helo√≠sa", photo: "heloisa_alfa.png" },
                { id: 13, name: "J√∫lio", photo: "julio_alfa.png" },
                { id: 14, name: "Bernardo", photo: "bernardo_alfa.png" },
                { id: 15, name: "Isadora", photo: "isadora_alfa.png" },
                { id: 16, name: "Emanuel", photo: "emanuel_alfa.png" },
                { id: 17, name: "Heitor", photo: "heitor_alfa.png" },
                { id: 18, name: "Davi", photo: "davi_alfa.png" }
            ],
            beta: [ 
                { id: 19, name: "Mait√™", photo: "maite_beta.png" },
                { id: 20, name: "Liz Pacheco", photo: "liz_pacheco_beta.png" },
                { id: 21, name: "Helena M.", photo: "helena_beta.png" },
                { id: 22, name: "Pedro", photo: "pedro_beta.png" },
                { id: 23, name: "Tiffany", photo: "tiffany_beta.png" },
                { id: 24, name: "Arthur Souza", photo: "arthur_beta.png" },
                { id: 25, name: "Jo√£o", photo: "joao_beta.png" },
                { id: 26, name: "Jos√© Lu√≠s", photo: "jose_luis_beta.png" },
                { id: 27, name: "Jo√£o Miguel", photo: "joao_miguel_beta.png" },
                { id: 28, name: "Matteo", photo: "matteo_beta.png" },
                { id: 29, name: "Murilo", photo: "murilo_beta.png" },
                { id: 30, name: "Elisa", photo: "elisa_beta.png" },
                { id: 31, name: "Safira", photo: "safira_beta.png" },
                { id: 32, name: "Manuella", photo: "manuella_beta.png" },
                { id: 33, name: "Nicoly", photo: "nicoly_beta.png" },
                { id: 34, name: "Helena P.", photo: "helena_p_beta.png" },
                { id: 35, name: "Enrico J.", photo: "enrico_beta.png" },
                { id: 36, name: "Liz Medeiros", photo: "liz_Medeiros_beta.png" },
                { id: 37, name: "Arthur R.", photo: "arthur_beta.png" },
                { id: 38, name: "Benjamin", photo: "benjamin_beta.png" },
                { id: 39, name: "Ana Luiza", photo: "ana_luiza_beta.png" }
            ],
            gama: [ 
                { id: 39, name: "Isaac", photo: "isaac_gama.png" },
                { id: 40, name: "Davi", photo: "davi_gama.png" },
                { id: 41, name: "Sophia", photo: "sophia_gama.png" },
                { id: 42, name: "Wendel", photo: "wendel_gama.png" },
                { id: 43, name: "Isabela", photo: "isabela_gama.png" },
                { id: 44, name: "Lauren", photo: "lauren_gama.png" },
                { id: 45, name: "Brayan", photo: "brayan_gama.png" },
                { id: 46, name: "Elisa", photo: "elisa_gama.png" },
                { id: 47, name: "Emanuelly", photo: "emanuelly_gama.png" },
                { id: 48, name: "Kau√£", photo: "kaua_gama.png" },
                { id: 49, name: "Vicente", photo: "vicente_gama.png" },
                { id: 50, name: "Elisa Rom√£o", photo: "elisa_romao_gama.png" },
                { id: 51, name: "Helena", photo: "helena_gama.png" },
                { id: 52, name: "Ana Clara", photo: "ana_clara_gama.png" },
                { id: 53, name: "√ârick", photo: "erick_gama.png" },
                { id: 54, name: "Lorenzo", photo: "lorenzo_gama.png" },
                { id: 55, name: "Theo", photo: "theo_gama.png" }
            ],
            √¥mega: [ 
                { id: 56, name: "Nicolly", photo: "nicolly_omega.png" },
                { id: 57, name: "Saulo", photo: "saulo_omega.png" },
                { id: 58, name: "Kemily", photo: "kemily_omega.png" },
                { id: 59, name: "Maria Eduarda", photo: "maria_eduarda_omega.png" },
                { id: 60, name: "Lorena", photo: "lorena_omega.png" },
                { id: 61, name: "Laura", photo: "laura_omega.png" },
                { id: 62, name: "Eduardo", photo: "eduardo_omega.png" },
                { id: 63, name: "Kau√£", photo: "kaua_omega.png" },
                { id: 64, name: "Pedro Lucas", photo: "pedro_lucas_omega.png" },
                { id: 65, name: "Italo", photo: "italo_omega.png" },
                { id: 66, name: "Davi", photo: "davi_omega.png" },
                { id: 67, name: "Laiz", photo: "laiz_omega.png" },
                { id: 68, name: "Micael", photo: "micael_omega.png" },
                { id: 69, name: "Ketelly", photo: "ketelly_omega.png" },
                { id: 70, name: "Bernardo", photo: "bernardo_omega.png" },
                { id: 71, name: "Asafe", photo: "asafe_omega.png" },
                { id: 72, name: "Isabelly", photo: "isabelly_omega.png" },
                { id: 73, name: "Heitor", photo: "heitor_omega.png" },
                { id: 74, name: "L√≠via", photo: "livya_omega.png" },
                { id: 75, name: "Smith", photo: "smith_omega.png" },
                { id: 76, name: "Mikeias", photo: "mikeias_omega.png" },
                { id: 77, name: "Raphaela", photo: "raphaela_omega.png" },
                { id: 78, name: "√âric", photo: "eric_omega.png" },
                { id: 79, name: "Lav√≠nia", photo: "lavinia_omega.png" },
                { id: 80, name: "Pietra", photo: "pietra_omega.png" },
                { id: 81, name: "Sophia", photo: "sophia_omega.png" },
                { id: 82, name: "Jo√£o Miguel", photo: "joao_miguel_omega.png" },
                { id: 83, name: "Maria", photo: "maria_omega.png" }
            ]
        };
        
        // DADOS SOMENTE DA ABA ESCALAS (Mantidos)
        const scheduleData = {
             ber√ßario: {
                 ...roomsData.ber√ßario,
                 schedules: [
                     { date: "02/11/2025", lesson: "13¬∞", teachers: ["Eliane Rodrigues dos Santos", "Wagna da Penha meneguite", "ANA RAFAELA"] },
                     { date: "09/11/2025", lesson: "14¬∞", teachers: ["Juscilene Amaral Pereira", "ERICA", "Luiza Messa Lemos Farias"] },
                     { date: "16/11/2025", lesson: "15¬∞", teachers: ["Leidiane Lopes dos Santos da Silva", "Adriana Lopes dos Santos Martins", "Sarah dos santos Tomaz"] },
                     { date: "23/11/2025", lesson: "16¬∞", teachers: ["MAIARA", "Jussimere Pacheco da Silva", "Kemelly Ribeiro Dos Santos"] },
                     { date: "30/11/2025", lesson: "17¬∞", teachers: ["Eliane Rodrigues dos Santos", "Ingrid Silva Coelho", "DUDA"] }
                 ]
             },
             alfa: {
                 ...roomsData.alfa,
                 schedules: [
                     { date: "02/11/2025", lesson: "13¬∞", teachers: ["Paulo Henrique Mendes Dias", "Iandra Jesus de Novais Santana", "KETTLEY"] },
                     { date: "09/11/2025", lesson: "14¬∞", teachers: ["Roseane Jadyvsky", "ESTER", "Anna Vict√≥ria Bebiano de Carvalho"] },
                     { date: "16/11/2025", lesson: "15¬∞", teachers: ["ROSE PIMENTA", "Stefani Rodrigues Vieira", "RYAN"] },
                     { date: "23/11/2025", lesson: "16¬∞", teachers: ["Marilene Francisca Batista", "Amanda Francisca Batista dos Santos", "KETTLEY"] },
                     { date: "30/11/2025", lesson: "17¬∞", teachers: ["Arthur dos Santos da concei√ß√£o", "Iandra Jesus de Novais Santana", "RYAN"] }
                 ]
             },
             beta: {
                 ...roomsData.beta,
                 schedules: [
                     { date: "02/11/2025", lesson: "13¬∞", teachers: ["N√∫bia Nascimento de Medeiros Dos Santos", "MARCIA", "DOUGLAS"] },
                     { date: "09/11/2025", lesson: "14¬∞", teachers: ["Ana Crysthina Martins Lyrio", "Elaine Pereira Rocha Anacleto ", "SOPHIA"] },
                     { date: "16/11/2025", lesson: "15¬∞", teachers: ["Ana Paula Nogueira Tongo", "Maxsuel Oliveira da Silva", "JEAN"] },
                     { date: "23/11/2025", lesson: "16¬∞", teachers: ["MARCIA", "Mirian Pereira da Cruz da Cunha", "HELOISA"] },
                     { date: "30/11/2025", lesson: "17¬∞", teachers: ["N√∫bia Nascimento de Medeiros Dos Santos", "ANA PAULA", "JEAN"] }
                 ]
             },
             gama: {
                 ...roomsData.gama,
                 schedules: [
                     { date: "02/11/2025", lesson: "13¬∞", teachers: ["Ramon de Oliveira Correa", "Ana Clara Silva Petersen"] },
                     { date: "09/11/2025", lesson: "14¬∞", teachers: ["Lucas de Souza Fernandes", "Libhya da Silva Souza Gon√ßalves Victorino"] },
                     { date: "16/11/2025", lesson: "15¬∞", teachers: ["Alberto Fausther Da Silva De Souza", "Mikaeli Manoel Jacinto Furriel Gon√ßalves"] },
                     { date: "23/11/2025", lesson: "16¬∞", teachers: ["ARTHUR", "Ana Beatriz Rodrigues de Souza", "Alex Gon√ßalves Victorino"] },
                     { date: "30/11/2025", lesson: "17¬∞", teachers: ["Paulo Henrique Mendes Dias", "Libhya da Silva Souza Gon√ßalves Victorino", "Stefani Rodrigues Vieira"] }
                 ]
             },
             √¥mega: {
                 ...roomsData.√¥mega,
                 schedules: [
                     { date: "02/11/2025", lesson: "13¬∞", teachers: ["Kau√£ Guimar√£es Stein", "Brunara dos Santos Alves"] },
                     { date: "09/11/2025", lesson: "14¬∞", teachers: ["Brenda Rodrigues de Souza", "JOICE"] },
                     { date: "16/11/2025", lesson: "15¬∞", teachers: ["Diego Pimenta", "Raiara da Concei√ß√£o Viana Pimenta"] },
                     { date: "23/11/2025", lesson: "16¬∞", teachers: ["Jackson Jadyvysky", "Luiz Felipe Oliveira dos Santos"] },
                     { date: "30/11/2025", lesson: "17¬∞", teachers: ["Kau√£ Guimar√£es Stein", "Brunara dos Santos Alves"] }
                 ]
             }
        };
        
        const allDates = ["02/11/2025", "09/11/2025", "16/11/2025", "23/11/2025", "30/11/2025"];

        // VARI√ÅVEIS DE ESTADO DA ABA ESCALAS
        let selectedDate = null;
        let selectedRoom = null;
        let searchTerm = ''; 

        // VARI√ÅVEIS DE ESTADO DA ABA CHAMADA
        let selectedRoomKeyChamada = null;
        let extraKidCounter = 0;

        // VARI√ÅVEIS DE ESTADO DA ABA LI√á√ïES (NOVAS)
        let selectedRoomKeyLicoes = null;
        let selectedDateLicoes = null;
        let selectedFile = null;

        /* ---------------------------------- */
        /* FUN√á√ïES GERAIS (ABAS)             */
        /* ---------------------------------- */

        function openTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById('tab-' + tabId).classList.add('active');
            element.classList.add('active');
            
            if (tabId === 'chamada') {
                if (selectedRoomKeyChamada) {
                    const activeTab = document.querySelector(`#roomTabsCall .room-tab-call[data-room-key="${selectedRoomKeyChamada}"]`);
                    if (activeTab) {
                        activeTab.classList.add('active');
                    }
                    renderKidsList(selectedRoomKeyChamada); 
                    document.getElementById('extraKidName').disabled = false;
                    document.querySelector('.btn-add-kid').disabled = false;

                } else {
                    renderEmptyKidsList();
                    document.getElementById('extraKidName').disabled = true;
                    document.querySelector('.btn-add-kid').disabled = true;
                }
                checkCallFormValidity();
            } else if (tabId === 'licoes') {
                checkLessonFormValidity();
                if (selectedRoomKeyLicoes && selectedDateLicoes) {
                    displayLesson(selectedRoomKeyLicoes, selectedDateLicoes);
                } else {
                    displayLessonEmptyState();
                }
            }
        }


        /* ---------------------------------- */
        /* FUN√á√ïES DA ABA ESCALAS (Mantidas) */
        /* ---------------------------------- */
        
        function resetDateAndRoomFilters() {
            selectedDate = null;
            selectedRoom = null;
            document.querySelectorAll('#tab-escalas .date-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#tab-escalas .room-btn').forEach(b => b.classList.remove('active'));
        }
        
        function filterByTeacher(term) {
            searchTerm = term.toUpperCase().trim();
            
            if (searchTerm.length > 0) {
                resetDateAndRoomFilters(); 
            }
            
            renderSchedules();
        }

        function initializeDateButtons() {
            const container = document.getElementById('dateButtons');
            container.innerHTML = '';
            
            allDates.forEach(date => {
                const btn = document.createElement('button');
                btn.className = 'date-btn';
                btn.textContent = date;
                btn.onclick = () => selectDate(date, btn);
                container.appendChild(btn);
            });
        }

        function initializeRoomButtons() {
            const container = document.getElementById('roomButtons');
            container.innerHTML = '';
            
            Object.keys(scheduleData).forEach(roomKey => {
                const room = scheduleData[roomKey];
                const btn = document.createElement('button');
                btn.className = 'room-btn';
                btn.innerHTML = `
                    <span class="room-icon-btn">${room.icon}</span>
                    <div class="room-text">
                        <div>${room.name}</div>
                        <div class="room-age">${room.age}</div>
                    </div>
                `;
                btn.onclick = () => selectRoomEscalas(roomKey, btn);
                container.appendChild(btn);
            });
        }

        function selectDate(date, btn) {
            document.querySelectorAll('#tab-escalas .date-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#tab-escalas .room-btn').forEach(b => b.classList.remove('active'));
            selectedRoom = null; 

            if (selectedDate === date) {
                selectedDate = null;
            } else {
                selectedDate = date;
                btn.classList.add('active');
            }
            
            searchTerm = ''; 
            document.getElementById('teacherSearchInput').value = ''; 
            renderSchedules();
        }

        function selectRoomEscalas(roomKey, btn) {
            document.querySelectorAll('#tab-escalas .room-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#tab-escalas .date-btn').forEach(b => b.classList.remove('active'));
            selectedDate = null; 

            if (selectedRoom === roomKey) {
                selectedRoom = null;
            } else {
                selectedRoom = roomKey;
                btn.classList.add('active');
            }
            
            searchTerm = ''; 
            document.getElementById('teacherSearchInput').value = '';
            renderSchedules();
        }

        function renderSchedules() {
            const container = document.getElementById('scheduleGrid');
            const resultsTitle = document.getElementById('resultsTitle');
            container.innerHTML = '';

            let allSchedules = [];
            Object.keys(scheduleData).forEach(roomKey => {
                const room = scheduleData[roomKey];
                room.schedules.forEach(schedule => {
                    allSchedules.push({ roomKey, room, schedule });
                });
            });

            let filteredSchedules = allSchedules.filter(item => {
                const { roomKey, schedule } = item;
                
                if (searchTerm) {
                    const teachersUpper = schedule.teachers.map(t => t.toUpperCase());
                    return teachersUpper.some(t => t.includes(searchTerm));
                }

                if (selectedDate && schedule.date !== selectedDate) {
                    return false;
                }

                if (selectedRoom && roomKey !== selectedRoom) {
                    return false;
                }

                return true;
            });
            
            let scheduleCount = filteredSchedules.length;

            filteredSchedules.forEach(({ room, schedule }) => {
                const isSantaCeia = schedule.date === '09/11/2025'; 

                const card = document.createElement('div');
                card.className = 'schedule-card' + (isSantaCeia ? ' santa-ceia-highlight' : '');
                
                card.innerHTML = `
                    <div class="schedule-header">
                        <div class="room-name">
                            <span class="room-name-icon">${room.icon}</span>
                            Sala ${room.name}
                        </div>
                        <div class="room-age-display">${room.age}</div>
                        <div class="date-info">
                            <div class="schedule-date">üìÖ ${schedule.date}</div>
                            <div class="lesson-badge">Li√ß√£o ${schedule.lesson}</div>
                        </div>
                    </div>
                    <div class="teachers-section">
                        <div class="teachers-label">üë• Professores:</div>
                        <div class="teachers-list">
                            ${schedule.teachers.filter(t => t && t.trim() !== '').map(teacher => {
                                const isHighlighted = searchTerm && teacher.toUpperCase().includes(searchTerm);
                                return `<div class="teacher-card" ${isHighlighted ? 'style="border: 2px solid #667eea; background: #e6e9f9;"' : ''}>üë®‚Äçüî¨ ${teacher}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            if (scheduleCount === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>Nenhuma escala encontrada</h3>
                        <p>Verifique o nome do professor ou redefina os filtros.</p>
                    </div>
                `;
            }

            let titleText = 'Todas as Escalas';
            if (searchTerm) {
                titleText = `Resultados para "${searchTerm}" (${scheduleCount})`;
            } else if (selectedDate && selectedRoom) {
                titleText = `${selectedDate} - ${scheduleData[selectedRoom].name}`;
            } else if (selectedDate) {
                titleText = `Escalas de ${selectedDate}`;
            } else if (selectedRoom) {
                titleText = `Sala ${scheduleData[selectedRoom].name}`;
            }
            resultsTitle.textContent = titleText;
        }

        function resetFilters() {
            resetDateAndRoomFilters(); 
            searchTerm = ''; 
            document.getElementById('teacherSearchInput').value = ''; 
            renderSchedules();
        }

        function exportToCSV() {
            let csv = 'Sala,Idade,Data,Li√ß√£o,Professor 1,Professor 2,Professor 3\n';
            
            Object.keys(scheduleData).forEach(roomKey => {
                const room = scheduleData[roomKey];
                room.schedules.forEach(schedule => {
                    const teachers = schedule.teachers.filter(t => t && t.trim() !== '');
                    const t1 = teachers[0] || '';
                    const t2 = teachers[1] || '';
                    const t3 = teachers[2] || '';
                    csv += `${room.name},${room.age},${schedule.date},${schedule.lesson},"${t1}","${t2}","${t3}"\n`;
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'escalas_ministerio_infantil.csv';
            link.click();
        }

        /* ---------------------------------- */
        /* FUN√á√ïES DA ABA CHAMADA (Mantidas) */
        /* ---------------------------------- */

        function checkCallFormValidity() {
            const teacherName = document.getElementById('teacherName').value.trim();
            const date = document.getElementById('dateInput').value;
            const submitBtn = document.querySelector('.btn-submit');
            
            const isValid = selectedRoomKeyChamada && teacherName && date;
            
            submitBtn.disabled = !isValid;
        }
        
        function initializeRoomTabsChamada() {
            const container = document.getElementById('roomTabsCall');
            container.innerHTML = '';
            
            Object.keys(roomsData).forEach(roomKey => {
                const room = roomsData[roomKey];
                const tab = document.createElement('div');
                tab.className = 'room-tab-call';
                tab.setAttribute('data-room-key', roomKey);
                tab.innerHTML = `<div class="room-name-tab">${room.icon} ${room.name}</div><div class="room-age-tab">${room.age}</div>`;
                tab.onclick = () => selectRoomChamada(roomKey, tab);
                container.appendChild(tab);
            });
            
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('dateInput').value = `${yyyy}-${mm}-${dd}`;
            
            renderEmptyKidsList();
            checkCallFormValidity();
        }
        
        function renderEmptyKidsList() {
            document.getElementById('kidsList').innerHTML = `
                <div class="empty-state">
                    Escolha uma sala para come√ßar a lista de chamada.
                </div>
            `;
            document.getElementById('chamadaTitle').innerHTML = `üìù Chamada - Selecione a Sala Acima üëÜ`;
        }

        function togglePresence(element) {
            if (element.classList.contains('extra') && element.classList.contains('present')) {
                element.classList.remove('present');

                setTimeout(() => {
                    if (confirm(`Remover "${element.getAttribute('data-kid-name')}" da lista de extras?`)) {
                        element.remove();
                    } else {
                        element.classList.add('present');
                    }
                    checkCallFormValidity();
                }, 100); 
                return;
            }
            
            element.classList.toggle('present');
            checkCallFormValidity();
        }

        function selectRoomChamada(roomKey, tabElement) {
            document.querySelectorAll('.room-tab-call').forEach(t => t.classList.remove('active'));
            
            if (tabElement) {
                tabElement.classList.add('active');
            }
            selectedRoomKeyChamada = roomKey;
            
            const room = roomsData[roomKey];
            document.getElementById('chamadaTitle').innerHTML = `üìù Chamada - ${room.icon} Sala ${room.name}`;
            renderKidsList(roomKey);
            
            document.getElementById('extraKidName').disabled = false;
            document.querySelector('.btn-add-kid').disabled = false;

            checkCallFormValidity();
        }

        function addExtraKid() {
            const extraKidNameInput = document.getElementById('extraKidName');
            const name = extraKidNameInput.value.trim();
            const kidsGrid = document.querySelector('#kidsList .kids-grid');

            if (!name) {
                alert("Por favor, digite o nome da crian√ßa!");
                return;
            }

            if (!kidsGrid) {
                alert("Selecione uma sala primeiro!");
                return;
            }
            
            extraKidCounter++;
            
            const newKidCard = document.createElement('div');
            newKidCard.className = 'kid-card extra present';
            newKidCard.setAttribute('onclick', 'togglePresence(this)');
            newKidCard.setAttribute('data-kid-name', `${name} (Extra)`);

            newKidCard.innerHTML = `
                <div class="kid-photo">‚ú®</div>
                <div class="kid-name">${name}</div>
            `;
            
            kidsGrid.appendChild(newKidCard);
            
            extraKidNameInput.value = '';
            extraKidNameInput.focus();
            
            checkCallFormValidity();
        }
        
        function renderKidsList(roomKey) {
            const container = document.getElementById('kidsList');
            const kids = kidsData[roomKey] || [];
            
            if (kids.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Lista de Crian√ßas Vazia</h3>
                        <p>Nenhuma crian√ßa cadastrada para esta sala.</p>
                    </div>
                `;
                return;
            }
            
            let html = `<div class="form-label">üëã Toque na foto da crian√ßa que est√° PRESENTE</div>`;
            html += `<div class="kids-grid">`;
            
            kids.forEach(kid => {
                const photoUrl = kid.photo.startsWith('http') ? kid.photo : `img/${kid.photo}`;
                
                html += `
                    <div class="kid-card" onclick="togglePresence(this)" data-kid-name="${kid.name}">
                        <img class="kid-photo" src="${photoUrl}" alt="${kid.name}" onerror="this.onerror=null; this.src='https://via.placeholder.com/150/667eea/ffffff?text=üë∂';">
                        <div class="kid-name">${kid.name}</div>
                    </div>
                `;
            });

            html += `</div>`;
            container.innerHTML = html;
        }
        
        async function submitCall() {
            if (!selectedRoomKeyChamada) {
                alert("Por favor, selecione uma Sala!");
                return;
            }

            const submitBtn = document.querySelector('.btn-submit');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Enviando...';

            const teacherName = document.getElementById('teacherName').value.trim();
            const date = document.getElementById('dateInput').value;

            if (!teacherName || !date) {
                alert("Por favor, preencha seu nome e a data da aula!");
                submitBtn.disabled = false;
                submitBtn.textContent = '‚úÖ Finalizar Chamada';
                checkCallFormValidity();
                return;
            }
            
            const room = roomsData[selectedRoomKeyChamada];
            
            const presentKidsElements = document.querySelectorAll('#kidsList .kid-card.present');
            const presentKids = Array.from(presentKidsElements).map(el => el.getAttribute('data-kid-name'));

            const totalPresent = presentKids.length;

            if (totalPresent === 0) {
                alert("Nenhuma crian√ßa registrada! Por favor, toque no cart√£o das crian√ßas presentes.");
                submitBtn.disabled = false;
                submitBtn.textContent = '‚úÖ Finalizar Chamada';
                checkCallFormValidity();
                return;
            }
            
            const formData = new URLSearchParams();
            formData.append('room_name', room.name);
            formData.append('room_age', room.age);
            formData.append('lesson_date', date);
            formData.append('teacher_name', teacherName);
            formData.append('total_present', totalPresent);
            formData.append('kids_list', presentKids.join('; '));

            try {
                const response = await fetch(SHEET_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    body: formData
                });
                
                document.querySelectorAll('#kidsList .kid-card').forEach(card => {
                    if (card.classList.contains('extra')) {
                        card.remove();
                    } else {
                        card.classList.remove('present');
                    }
                });
                document.getElementById('extraKidName').value = '';
                extraKidCounter = 0;

                alert(`üéâ Chamada da Sala ${room.name} conclu√≠da com sucesso! Os ${totalPresent} nomes foram enviados para a planilha.`);

            } catch (error) {
                console.error("Erro ao enviar dados para o Google Sheet:", error);
                alert("‚ùå Erro ao enviar a chamada. Tente novamente ou verifique a conex√£o.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '‚úÖ Finalizar Chamada';
                checkCallFormValidity();
            }
        }
        
        // ======================================================================================
        // --- FUN√á√ïES DA ABA LI√á√ïES üìñ (ATUALIZADAS PARA O DOWNLOAD) 
        // ======================================================================================

        /**
        * Fun√ß√£o auxiliar para buscar o status do arquivo no Apps Script (Drive).
        */
        async function fetchLessonStatus(roomKey, date) {
            if (!roomKey || !date) return { status: 'error', message: 'Dados de busca incompletos.' };
            
            const room = roomsData[roomKey];

            const url = new URL(SHEET_URL);
            url.searchParams.append('action', 'checkLesson');
            url.searchParams.append('room_name', room.name);
            url.searchParams.append('lesson_date', date);

            try {
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    mode: 'cors' 
                });
                
                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error("Erro ao buscar status do arquivo no Drive:", error);
                return { status: 'error', message: `Erro de comunica√ß√£o com o Apps Script: ${error.message}` };
            }
        }

        /**
        * ATUALIZADA: Verifica o status da li√ß√£o no Drive e habilita/desabilita bot√µes.
        */
        function checkLessonFormValidity() {
            const isReady = selectedRoomKeyLicoes && selectedDateLicoes;
            const hasFileSelected = selectedFile !== null;
            
            // Habilita o upload se estiver pronto e o arquivo selecionado
            document.getElementById('btnUploadLesson').disabled = !(isReady && hasFileSelected);
            
            // Habilita download e delete se houver um ID de arquivo (significa que est√° salvo no Drive)
            document.getElementById('btnDownloadLesson').disabled = !currentLessonFileId;
            document.getElementById('btnDeleteLesson').disabled = !currentLessonFileId;
            
            if (currentLessonFileId) {
                document.getElementById('fileUploadLabel').style.display = 'none';
                document.getElementById('fileInfo').textContent = `‚úÖ Li√ß√£o salva no Google Drive e pronta para visualiza√ß√£o/download!`;
            } else if (isReady) {
                document.getElementById('fileUploadLabel').style.display = 'block';
                document.getElementById('fileInfo').textContent = hasFileSelected ? 
                    `‚úÖ Arquivo selecionado: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)` : 
                    "Nenhuma li√ß√£o salva. Selecione um PDF e clique em 'Enviar Li√ß√£o'.";
            } else {
                document.getElementById('fileUploadLabel').style.display = 'block';
                document.getElementById('fileInfo').textContent = "Selecione a Sala e Data para gerenciar a li√ß√£o.";
            }
        }

        function initializeRoomTabsLicoes() {
            const container = document.getElementById('roomTabsLessons');
            container.innerHTML = '';
            
            Object.keys(roomsData).forEach(roomKey => {
                const room = roomsData[roomKey];
                const btn = document.createElement('button');
                btn.className = 'room-btn';
                btn.innerHTML = `
                    <span class="room-icon-btn">${room.icon}</span>
                    <div class="room-text">
                        <div>${room.name}</div>
                        <div class="room-age">${room.age}</div>
                    </div>
                `;
                btn.onclick = () => selectRoomLicoes(roomKey, btn);
                container.appendChild(btn);
            });
        }
        
        function initializeDateButtonsLicoes() {
            const container = document.getElementById('dateButtonsLessons');
            container.innerHTML = '';
            
            allDates.forEach(date => {
                const btn = document.createElement('button');
                btn.className = 'date-btn';
                btn.textContent = date;
                btn.onclick = () => selectDateLicoes(date, btn);
                container.appendChild(btn);
            });
        }
        
        function selectRoomLicoes(roomKey, btn) {
            selectedFile = null;
            document.getElementById('pdfFile').value = '';
            
            document.querySelectorAll('#roomTabsLessons .room-btn').forEach(b => b.classList.remove('active'));

            if (selectedRoomKeyLicoes === roomKey) {
                selectedRoomKeyLicoes = null;
            } else {
                selectedRoomKeyLicoes = roomKey;
                btn.classList.add('active');
            }
            
            if (selectedRoomKeyLicoes && selectedDateLicoes) {
                displayLesson(selectedRoomKeyLicoes, selectedDateLicoes);
            } else {
                displayLessonEmptyState();
            }
            checkLessonFormValidity();
        }
        
        function selectDateLicoes(date, btn) {
            selectedFile = null;
            document.getElementById('pdfFile').value = '';
            
            document.querySelectorAll('#dateButtonsLessons .date-btn').forEach(b => b.classList.remove('active'));

            if (selectedDateLicoes === date) {
                selectedDateLicoes = null;
            } else {
                selectedDateLicoes = date;
                btn.classList.add('active');
            }
            
            if (selectedRoomKeyLicoes && selectedDateLicoes) {
                displayLesson(selectedRoomKeyLicoes, selectedDateLicoes);
            } else {
                displayLessonEmptyState();
            }
            checkLessonFormValidity();
        }
        
        function handleFileSelect() {
            const fileInput = document.getElementById('pdfFile');
            if (fileInput.files.length === 0) {
                selectedFile = null;
            } else {
                const file = fileInput.files[0];
                if (file.type !== 'application/pdf') {
                    alert("Apenas arquivos PDF s√£o permitidos.");
                    fileInput.value = '';
                    selectedFile = null;
                } else if (file.size > MAX_FILE_SIZE_BYTES) {
                    alert(`O arquivo √© muito grande. O limite √© de ${(MAX_FILE_SIZE_BYTES / 1024 / 1024).toFixed(0)} MB.`);
                    fileInput.value = '';
                    selectedFile = null;
                } else {
                    selectedFile = file;
                }
            }
            checkLessonFormValidity();
        }

        /**
        * NOVO: Dispara o download usando o ID do arquivo.
        */
        function downloadLesson() {
            if (!currentLessonFileId) {
                alert("Nenhuma li√ß√£o encontrada para download.");
                return;
            }

            const downloadUrl = `https://drive.google.com/uc?export=download&id=${currentLessonFileId}`;
            
            // Abre o link em uma nova aba para for√ßar o download
            window.open(downloadUrl, '_blank');
        }

        /**
        * ATUALIZADA: Converte o arquivo para Base64 e o envia para o Apps Script (Google Drive).
        */
        async function uploadLesson() {
            if (!selectedFile || !selectedRoomKeyLicoes || !selectedDateLicoes) {
                alert("Por favor, selecione a Sala, Data e o arquivo PDF.");
                return;
            }
            
            const uploadBtn = document.getElementById('btnUploadLesson');
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Enviando para o Drive...';

            // Convers√£o do arquivo para Base64
            const reader = new FileReader();

            reader.onload = async function(event) {
                // Remove o cabe√ßalho "data:application/pdf;base64,"
                const base64Data = event.target.result.split(',')[1]; 
                
                const room = roomsData[selectedRoomKeyLicoes];
                
                const payload = {
                    action: 'uploadLesson',
                    room_name: room.name,
                    lesson_date: selectedDateLicoes,
                    file_base64: base64Data
                };

                try {
                    // Chamada POST para o Apps Script para realizar o upload
                    const response = await fetch(SHEET_URL, {
                        method: 'POST',
                        mode: 'cors', 
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        alert(`üéâ Upload conclu√≠do: ${result.message}`);
                    } else {
                        alert(`‚ùå Erro no Apps Script: ${result.message}`);
                        console.error(result.message);
                    }

                } catch (error) {
                    console.error("Erro ao enviar dados para o Apps Script:", error);
                    alert("‚ùå Erro de rede ou CORS. Verifique o console e o seu Apps Script.");
                } finally {
                    uploadBtn.textContent = '‚¨ÜÔ∏è Enviar Li√ß√£o';
                    selectedFile = null;
                    document.getElementById('pdfFile').value = '';
                    // Recarrega a li√ß√£o para checar o status no Drive e exibir
                    await displayLesson(selectedRoomKeyLicoes, selectedDateLicoes); 
                }
            };

            reader.onerror = function() {
                alert("Erro ao ler o arquivo.");
                uploadBtn.disabled = false;
                uploadBtn.textContent = '‚¨ÜÔ∏è Enviar Li√ß√£o';
                checkLessonFormValidity();
            };

            reader.readAsDataURL(selectedFile);
        }

        /**
        * ATUALIZADA: Envia o comando de exclus√£o para o Apps Script (Google Drive).
        */
        async function deleteLesson() {
            if (!currentLessonFileId || !selectedRoomKeyLicoes || !selectedDateLicoes) {
                alert("Nenhuma li√ß√£o salva para esta data/sala para excluir.");
                return;
            }
            
            const room = roomsData[selectedRoomKeyLicoes];
            
            if (!confirm(`Tem certeza que deseja EXCLUIR a li√ß√£o salva para a Sala ${room.name} em ${selectedDateLicoes} do Google Drive?`)) {
                return;
            }

            const deleteBtn = document.getElementById('btnDeleteLesson');
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'üóëÔ∏è Excluindo...';
            
            const payload = {
                action: 'deleteLesson',
                room_name: room.name,
                lesson_date: selectedDateLicoes
            };

            try {
                const response = await fetch(SHEET_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (result.status === 'success') {
                    alert(`üóëÔ∏è Li√ß√£o exclu√≠da: ${result.message}`);
                    currentLessonFileUrl = null; 
                    currentLessonFileId = null; 
                } else {
                    alert(`‚ùå Erro ao excluir: ${result.message}`);
                    console.error(result.message);
                }

            } catch (error) {
                console.error("Erro de rede ou CORS ao excluir:", error);
                alert("‚ùå Erro de rede ou CORS. Verifique o console.");
            } finally {
                deleteBtn.textContent = 'üóëÔ∏è Excluir';
                // Atualiza a visualiza√ß√£o para mostrar que o arquivo foi removido
                await displayLesson(selectedRoomKeyLicoes, selectedDateLicoes); 
            }
        }

        /**
        * ATUALIZADA: Exibe a li√ß√£o no iframe, buscando o link diretamente do Google Drive.
        */
        async function displayLesson(roomKey, date) {
            const viewerContainer = document.getElementById('pdfViewerContent');
            const roomName = roomsData[roomKey].name;

            // Limpa o estado e mostra o estado de carregamento
            currentLessonFileUrl = null; 
            currentLessonFileId = null; 
            displayLessonEmptyState(`‚è≥ Verificando li√ß√£o para Sala ${roomName} em ${date}...`);
            
            // 1. Chama o Apps Script para verificar o status do arquivo e obter o URL e ID
            const statusResponse = await fetchLessonStatus(roomKey, date); 
            
            if (statusResponse.status === 'found') {
                const fileUrl = statusResponse.fileUrl;
                const fileId = statusResponse.fileId; // NOVO: Captura o ID
                
                currentLessonFileUrl = fileUrl; // Armazena o URL de visualiza√ß√£o no estado
                currentLessonFileId = fileId;   // Armazena o ID no estado (para download/delete)

                let iframe = document.getElementById('pdfViewerIframe');
                if (!iframe) {
                    viewerContainer.innerHTML = ''; 
                    iframe = document.createElement('iframe');
                    iframe.id = 'pdfViewerIframe';
                    iframe.className = 'pdf-viewer';
                    viewerContainer.appendChild(iframe);
                }
                
                iframe.src = fileUrl; // Define o src para o URL de visualiza√ß√£o do Google Drive
                displayLessonEmptyState(`‚úÖ Li√ß√£o Salva no Drive! Exibindo li√ß√£o para ${roomName}.`);
                
            } else {
                currentLessonFileUrl = null; 
                currentLessonFileId = null; 
                displayLessonEmptyState(`Nenhuma li√ß√£o salva para Sala ${roomName} em ${date}. Fa√ßa o upload.`);
            }

            checkLessonFormValidity();
        }
            
        function displayLessonEmptyState(message = 'Selecione uma sala e data acima.') {
            const viewerContainer = document.getElementById('pdfViewerContent');
            const existingIframe = document.getElementById('pdfViewerIframe');
            
            if (existingIframe) {
                existingIframe.remove();
            }
            
            if (!document.getElementById('lessonsEmptyState')) {
                viewerContainer.innerHTML = `
                    <div class="empty-state" id="lessonsEmptyState">
                        <h3>${message}</h3>
                        <p>O PDF da li√ß√£o ser√° carregado aqui, se existir.</p>
                    </div>
                `;
            } else {
                document.querySelector('#lessonsEmptyState h3').textContent = message;
                const pTag = document.querySelector('#lessonsEmptyState p');
                if(pTag) pTag.textContent = 'O PDF da li√ß√£o ser√° carregado aqui, se existir.';
            }
        }


        // INICIALIZA√á√ÉO GERAL
        initializeDateButtons();
        initializeRoomButtons();
        initializeRoomTabsChamada();
        renderSchedules();
        
        // INICIALIZA√á√ÉO DA ABA LI√á√ïES
        initializeRoomTabsLicoes();
        initializeDateButtonsLicoes();
        displayLessonEmptyState();

        // Adiciona listeners para validar o formul√°rio
        document.getElementById('teacherName').addEventListener('input', checkCallFormValidity);
        document.getElementById('dateInput').addEventListener('change', checkCallFormValidity);
    </script>
</body>
</html>
