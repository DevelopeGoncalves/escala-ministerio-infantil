<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ministério Infantil - Escalas e Chamada</title>
    <style>
        /* ESTILOS BASE - MANTIDOS E UNIFICADOS DO CÓDIGO 1 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 30px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1em;
            opacity: 0.95;
        }

        /* NOVO: ESTILOS DE ABAS (TABS) */
        .tabs-nav {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 15px;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 14px 10px;
            border: none;
            background: transparent;
            color: #764ba2;
            font-size: 1.05em;
            font-weight: 700;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        /* FIM: ESTILOS DE ABAS (TABS) */

        /* ESTILOS DE SEÇÃO (ORIGINAIS DOS CÓDIGOS 1 E 2) */
        .filter-section, .call-section, .results-section, .room-selection-section {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            margin-bottom: 20px;
        }

        .filter-title, .form-label {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ESTILOS DO CÓDIGO 1 (ESCALAS) */
        .date-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }

        .date-btn {
            padding: 16px 10px;
            border: 3px solid #e0e0e0;
            background: white;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #333;
            text-align: center;
            touch-action: manipulation;
        }

        .date-btn:active {
            transform: scale(0.95);
        }

        .date-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .room-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .room-btn {
            padding: 18px 15px;
            border: 3px solid #e0e0e0;
            background: white;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
            touch-action: manipulation;
        }

        .room-btn:active {
            transform: scale(0.98);
        }

        .room-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .room-icon-btn {
            font-size: 1.8em;
        }

        .room-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
        }

        .room-age {
            font-size: 0.85em;
            opacity: 0.8;
            font-weight: 500;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .btn {
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1.05em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-reset {
            background: #6c757d;
            color: white;
        }

        .btn-export {
            background: #10b981;
            color: white;
        }

        .results-header {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            line-height: 1.4;
        }

        .schedule-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .schedule-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 18px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }
        
        .schedule-card.santa-ceia-highlight {
            border-left: 5px solid #dc3545;
            background: linear-gradient(135deg, #fcebeb 0%, #f7636f 100%);
        }

        .schedule-card.santa-ceia-highlight .room-name {
            color: #c82333;
        }

        .schedule-card.santa-ceia-highlight .schedule-date {
            background: #dc3545;
            color: white;
        }

        .room-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .room-age-display {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }

        .date-info {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .schedule-date, .lesson-badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.95em;
        }

        .lesson-badge {
            background: #10b981;
        }

        .teacher-search {
            width: 100%;
            padding: 12px;
            margin-bottom: 25px; 
            border: 2px solid #ccc;
            border-radius: 12px;
            font-size: 1em;
            transition: border-color 0.2s ease;
        }
        .teacher-search:focus {
            border-color: #667eea;
            outline: none;
        }

        .teachers-label {
            font-weight: 700;
            color: #555;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .teachers-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .teacher-card {
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            font-weight: 600;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
            border: 2px solid transparent; 
            transition: all 0.2s ease;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #333;
        }

        /* ESTILOS DO CÓDIGO 2 (CHAMADA) - UNIFICADOS */
        .room-selection-section {
            padding: 15px; 
            margin-bottom: 20px;
        }

        .room-tabs-call { /* Renomeado para evitar conflito com .room-tabs-nav */
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .room-tab-call { /* Renomeado para evitar conflito com .tab-btn */
            flex: 1 1 45%; 
            min-width: 120px;
            padding: 15px 10px;
            border: 3px solid #e0e0e0; /* Ajustado para 3px para combinar com o .room-btn do código 1 */
            background: white; /* Ajustado para white para combinar com o .room-btn do código 1 */
            border-radius: 12px; /* Ajustado para 12px para combinar com o .room-btn do código 1 */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            color: #333; /* Ajustado para #333 para combinar com o .room-btn do código 1 */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .room-tab-call.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .room-tab-call:active {
            transform: scale(0.98); /* Ajustado para 0.98 para combinar com o .room-btn do código 1 */
        }

        .room-name-tab {
            font-size: 1.1em;
        }

        .room-age-tab {
            font-size: 0.8em;
            font-weight: 500;
            opacity: 0.8;
            margin-top: 3px;
        }

        .call-section h2 {
            font-size: 1.2em; /* Corrigido para não conflitar com h1 */
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .kid-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .kid-input-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ccc; /* Ajustado para 2px para combinar com o input geral */
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s ease;
        }
        
        .kid-input-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .kid-number {
            font-weight: 700;
            color: #667eea;
            width: 30px;
            text-align: center;
            font-size: 1.1em;
        }

        .btn-submit {
            background: #10b981;
            padding: 16px 20px; /* Ajustado para combinar com os botões do Código 1 */
            border-radius: 12px; /* Ajustado para combinar com os botões do Código 1 */
            font-size: 1.05em; /* Ajustado para combinar com os botões do Código 1 */
            margin-top: 25px;
        }
        
        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        /* Outros ajustes de estilo */
            input[type="date"], #teacherName {
            width: 100%;
            /* Alterações Feitas AQUI: */
            padding: 16px; /* Aumenta a altura do campo (preenchimento interno) */
            font-size: 1.1em; /* Aumenta o tamanho do texto dentro do campo */
            /* Outras propriedades de estilo mantidas: */
            border: 2px solid #ccc; 
            border-radius: 12px;
            transition: border-color 0.2s ease;
        }

        html {
            scroll-behavior: smooth;
        }
        
        button:focus {
            outline: none;
        }
        
        @media (max-width: 360px) {
            h1 {
                font-size: 1.5em;
            }
            
            .date-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>✝️ Ministério Infantil ✝️</h1>
            <p class="subtitle">Escalas e Chamadas - Novembro 2025</p>
        </header>

        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="escalas" onclick="openTab('escalas', this)">Escalas 📅</button>
            <button class="tab-btn" data-tab="chamada" onclick="openTab('chamada', this)">Chamada 🔔</button>
        </div>
        <div class="tab-content active" id="tab-escalas">
            <div class="filter-section">
                <div class="filter-title">🔎 Buscar por Professor</div>
                <input type="text" id="teacherSearchInput" class="teacher-search" placeholder="Digite o nome do professor" oninput="filterByTeacher(this.value)">
                
                <div class="filter-title">📅 Escolha a Data</div>
                <div class="date-buttons" id="dateButtons"></div>

                <div class="filter-title">🏠 Escolha a Sala</div>
                <div class="room-buttons" id="roomButtons"></div>

                <div class="action-buttons">
                    <button class="btn btn-reset" onclick="resetFilters()">🔄 Mostrar Todas</button>
                    <button class="btn btn-export" onclick="exportToCSV()">📥 Exportar CSV</button>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    📋 <span id="resultsTitle">Todas as Escalas</span>
                </div>
                <div class="schedule-grid" id="scheduleGrid"></div>
            </div>
        </div>
        <div class="tab-content" id="tab-chamada">
            <div class="room-selection-section">
                <div class="form-label">🏠 Selecione a Sala (Etapa 1)</div>
                <div class="room-tabs-call" id="roomTabsCall">
                    </div>
            </div>

            <div class="call-section">
                <h2 class="form-label" id="chamadaTitle">📝 Chamada - Selecione a Sala Acima</h2>

                <div class="form-group">
                    <label for="teacherName" class="form-label">🧑‍🏫 Seu Nome:</label>
                    <input type="text" id="teacherName" placeholder="Seu nome completo" required>
                </div>

                <div class="form-group">
                    <label for="dateInput" class="form-label">📅 Data da Aula:</label>
                    <input type="date" id="dateInput" required>
                </div>
                
                <div id="kidsList">
                    <div class="empty-state">
                        Escolha uma sala para começar a lista de chamada.
                    </div>
                </div>

                <button class="btn btn-submit" onclick="submitCall()">✅ Finalizar Chamada</button>
            </div>
        </div>
        </div>

    <script>
        // *** SEU URL DO APPS SCRIPT DEPLOYED ESTÁ AQUI ***
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbzl3ajI4Vc7sdHe5aeuHji6mGyhA0elkigHSTZcpPJ7ZF0S0FZrpMC2mIRDq7hNXjKUgQ/exec';
        // ************************************************

        // DADOS COMPARTILHADOS (ESCALAS E CHAMADA)
        const roomsData = {
            berçario: { name: "Berçário", age: "0-2 anos", icon: "👶" },
            alfa: { name: "Alfa", age: "3-4 anos", icon: "🧸" },
            beta: { name: "Beta", age: "5-6 anos", icon: "🎨" },
            gama: { name: "Gama", age: "7-8 anos", icon: "⚽" },
            ômega: { name: "Ômega", age: "9-11 anos", icon: "📚" }
        };

        // DADOS SOMENTE DA ABA ESCALAS
        const scheduleData = {
            berçario: {
                ...roomsData.berçario,
                schedules: [
                    { date: "02/11/2025", lesson: "13°", teachers: ["Eliane Rodrigues dos Santos", "Wagna da Penha meneguite", "ANA RAFAELA"] },
                    { date: "09/11/2025", lesson: "14°", teachers: ["Juscilene Amaral Pereira", "ERICA", "Luiza Messa Lemos Farias"] },
                    { date: "16/11/2025", lesson: "15°", teachers: ["Leidiane Lopes dos Santos da Silva", "Adriana Lopes dos Santos Martins", "Sarah dos santos Tomaz"] },
                    { date: "23/11/2025", lesson: "16°", teachers: ["MAIARA", "Jussimere Pacheco da Silva", "Kemelly Ribeiro Dos Santos"] },
                    { date: "30/11/2025", lesson: "17°", teachers: ["Eliane Rodrigues dos Santos", "Ingrid Silva Coelho", "DUDA"] }
                ]
            },
            alfa: {
                ...roomsData.alfa,
                schedules: [
                    { date: "02/11/2025", lesson: "13°", teachers: ["Paulo Henrique Mendes Dias", "Iandra Jesus de Novais Santana", "KETTLEY"] },
                    { date: "09/11/2025", lesson: "14°", teachers: ["Roseane Jadyvsky", "ESTER", "Anna Victória Bebiano de Carvalho"] },
                    { date: "16/11/2025", lesson: "15°", teachers: ["ROSE PIMENTA", "Stefani Rodrigues Vieira", "RYAN"] },
                    { date: "23/11/2025", lesson: "16°", teachers: ["Marilene Francisca Batista", "Amanda Francisca Batista dos Santos", "KETTLEY"] },
                    { date: "30/11/2025", lesson: "17°", teachers: ["Arthur dos Santos da conceição", "Iandra Jesus de Novais Santana", "RYAN"] }
                ]
            },
            beta: {
                ...roomsData.beta,
                schedules: [
                    { date: "02/11/2025", lesson: "13°", teachers: ["Núbia Nascimento de Medeiros Dos Santos", "MARCIA", "DOUGLAS"] },
                    { date: "09/11/2025", lesson: "14°", teachers: ["Ana Crysthina Martins Lyrio", "Elaine Pereira Rocha Anacleto ", "SOPHIA"] },
                    { date: "16/11/2025", lesson: "15°", teachers: ["Ana Paula Nogueira Tongo", "Maxsuel Oliveira da Silva", "JEAN"] },
                    { date: "23/11/2025", lesson: "16°", teachers: ["MARCIA", "Mirian Pereira da Cruz da Cunha", "HELOISA"] },
                    { date: "30/11/2025", lesson: "17°", teachers: ["Núbia Nascimento de Medeiros Dos Santos", "ANA PAULA", "JEAN"] }
                ]
            },
            gama: {
                ...roomsData.gama,
                schedules: [
                    { date: "02/11/2025", lesson: "13°", teachers: ["Ramon de Oliveira Correa", "Ana Clara Silva Petersen"] },
                    { date: "09/11/2025", lesson: "14°", teachers: ["Lucas de Souza Fernandes", "Libhya da Silva Souza Gonçalves Victorino"] },
                    { date: "16/11/2025", lesson: "15°", teachers: ["Alberto Fausther Da Silva De Souza", "Mikaeli Manoel Jacinto Furriel Gonçalves"] },
                    { date: "23/11/2025", lesson: "16°", teachers: ["ARTHUR", "Ana Beatriz Rodrigues de Souza", "Alex Gonçalves Victorino"] },
                    { date: "30/11/2025", lesson: "17°", teachers: ["Paulo Henrique Mendes Dias", "Libhya da Silva Souza Gonçalves Victorino", "Stefani Rodrigues Vieira"] }
                ]
            },
            ômega: {
                ...roomsData.ômega,
                schedules: [
                    { date: "02/11/2025", lesson: "13°", teachers: ["Kauã Guimarães Stein", "Brunara dos Santos Alves"] },
                    { date: "09/11/2025", lesson: "14°", teachers: ["Brenda Rodrigues de Souza", "JOICE"] },
                    { date: "16/11/2025", lesson: "15°", teachers: ["Diego Pimenta", "Raiara da Conceição Viana Pimenta"] },
                    { date: "23/11/2025", lesson: "16°", teachers: ["Jackson Jadyvysky", "Luiz Felipe Oliveira dos Santos"] },
                    { date: "30/11/2025", lesson: "17°", teachers: ["Kauã Guimarães Stein", "Brunara dos Santos Alves"] }
                ]
            }
        };
        
        const allDates = ["02/11/2025", "09/11/2025", "16/11/2025", "23/11/2025", "30/11/2025"];

        // VARIÁVEIS DE ESTADO DA ABA ESCALAS
        let selectedDate = null;
        let selectedRoom = null;
        let searchTerm = ''; 

        // VARIÁVEIS DE ESTADO DA ABA CHAMADA
        let selectedRoomKeyChamada = null;
        const MAX_KIDS = 20;

        /* ---------------------------------- */
        /* FUNÇÕES GERAIS (ABAS)             */
        /* ---------------------------------- */

        function openTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById('tab-' + tabId).classList.add('active');
            element.classList.add('active');
            
            // Re-renderiza a lista de chamadas se for a aba "Chamada"
            if (tabId === 'chamada') {
                if (!selectedRoomKeyChamada) {
                    renderEmptyKidsList();
                } else {
                    renderKidsList();
                }
            }
        }


        /* ---------------------------------- */
        /* FUNÇÕES DA ABA ESCALAS            */
        /* ---------------------------------- */
        
        function resetDateAndRoomFilters() {
            selectedDate = null;
            selectedRoom = null;
            document.querySelectorAll('#tab-escalas .date-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#tab-escalas .room-btn').forEach(b => b.classList.remove('active'));
        }
        
        function filterByTeacher(term) {
            searchTerm = term.toUpperCase().trim();
            
            if (searchTerm.length > 0) {
                resetDateAndRoomFilters(); 
            }
            
            renderSchedules();
        }

        function initializeDateButtons() {
            const container = document.getElementById('dateButtons');
            container.innerHTML = '';
            
            allDates.forEach(date => {
                const btn = document.createElement('button');
                btn.className = 'date-btn';
                btn.textContent = date;
                btn.onclick = () => selectDate(date, btn);
                container.appendChild(btn);
            });
        }

        function initializeRoomButtons() {
            const container = document.getElementById('roomButtons');
            container.innerHTML = '';
            
            Object.keys(scheduleData).forEach(roomKey => {
                const room = scheduleData[roomKey];
                const btn = document.createElement('button');
                btn.className = 'room-btn';
                btn.innerHTML = `
                    <span class="room-icon-btn">${room.icon}</span>
                    <div class="room-text">
                        <div>${room.name}</div>
                        <div class="room-age">${room.age}</div>
                    </div>
                `;
                btn.onclick = () => selectRoomEscalas(roomKey, btn);
                container.appendChild(btn);
            });
        }

        function selectDate(date, btn) {
            document.querySelectorAll('#tab-escalas .date-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#tab-escalas .room-btn').forEach(b => b.classList.remove('active'));
            selectedRoom = null; 

            if (selectedDate === date) {
                selectedDate = null;
            } else {
                selectedDate = date;
                btn.classList.add('active');
            }
            
            searchTerm = ''; 
            document.getElementById('teacherSearchInput').value = ''; 
            renderSchedules();
        }

        function selectRoomEscalas(roomKey, btn) {
            document.querySelectorAll('#tab-escalas .room-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#tab-escalas .date-btn').forEach(b => b.classList.remove('active'));
            selectedDate = null; 

            if (selectedRoom === roomKey) {
                selectedRoom = null;
            } else {
                selectedRoom = roomKey;
                btn.classList.add('active');
            }
            
            searchTerm = ''; 
            document.getElementById('teacherSearchInput').value = '';
            renderSchedules();
        }

        function renderSchedules() {
            const container = document.getElementById('scheduleGrid');
            const resultsTitle = document.getElementById('resultsTitle');
            container.innerHTML = '';

            let allSchedules = [];
            Object.keys(scheduleData).forEach(roomKey => {
                const room = scheduleData[roomKey];
                room.schedules.forEach(schedule => {
                    allSchedules.push({ roomKey, room, schedule });
                });
            });

            let filteredSchedules = allSchedules.filter(item => {
                const { roomKey, schedule } = item;
                
                if (searchTerm) {
                    const teachersUpper = schedule.teachers.map(t => t.toUpperCase());
                    return teachersUpper.some(t => t.includes(searchTerm));
                }

                if (selectedDate && schedule.date !== selectedDate) {
                    return false;
                }

                if (selectedRoom && roomKey !== selectedRoom) {
                    return false;
                }

                return true;
            });
            
            let scheduleCount = filteredSchedules.length;

            filteredSchedules.forEach(({ room, schedule }) => {
                const isSantaCeia = schedule.date === '09/11/2025'; 

                const card = document.createElement('div');
                card.className = 'schedule-card' + (isSantaCeia ? ' santa-ceia-highlight' : '');
                
                card.innerHTML = `
                    <div class="schedule-header">
                        <div class="room-name">
                            <span class="room-name-icon">${room.icon}</span>
                            Sala ${room.name}
                        </div>
                        <div class="room-age-display">${room.age}</div>
                        <div class="date-info">
                            <div class="schedule-date">📅 ${schedule.date}</div>
                            <div class="lesson-badge">Lição ${schedule.lesson}</div>
                        </div>
                    </div>
                    <div class="teachers-section">
                        <div class="teachers-label">👥 Professores:</div>
                        <div class="teachers-list">
                            ${schedule.teachers.filter(t => t && t.trim() !== '').map(teacher => {
                                const isHighlighted = searchTerm && teacher.toUpperCase().includes(searchTerm);
                                return `<div class="teacher-card" ${isHighlighted ? 'style="border: 2px solid #667eea; background: #e6e9f9;"' : ''}>👨‍🔬 ${teacher}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            if (scheduleCount === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📭</div>
                        <h3>Nenhuma escala encontrada</h3>
                        <p>Verifique o nome do professor ou redefina os filtros.</p>
                    </div>
                `;
            }

            let titleText = 'Todas as Escalas';
            if (searchTerm) {
                titleText = `Resultados para "${searchTerm}" (${scheduleCount})`;
            } else if (selectedDate && selectedRoom) {
                titleText = `${selectedDate} - ${scheduleData[selectedRoom].name}`;
            } else if (selectedDate) {
                titleText = `Escalas de ${selectedDate}`;
            } else if (selectedRoom) {
                titleText = `Sala ${scheduleData[selectedRoom].name}`;
            }
            resultsTitle.textContent = titleText;
        }

        function resetFilters() {
            resetDateAndRoomFilters(); 
            searchTerm = ''; 
            document.getElementById('teacherSearchInput').value = ''; 
            renderSchedules();
        }

        function exportToCSV() {
            let csv = 'Sala,Idade,Data,Lição,Professor 1,Professor 2,Professor 3\n';
            
            Object.keys(scheduleData).forEach(roomKey => {
                const room = scheduleData[roomKey];
                room.schedules.forEach(schedule => {
                    const teachers = schedule.teachers.filter(t => t && t.trim() !== '');
                    const t1 = teachers[0] || '';
                    const t2 = teachers[1] || '';
                    const t3 = teachers[2] || '';
                    csv += `${room.name},${room.age},${schedule.date},${schedule.lesson},"${t1}","${t2}","${t3}"\n`; // Adicionado aspas para nomes com vírgulas
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'escalas_ministerio_infantil.csv';
            link.click();
        }

        /* ---------------------------------- */
        /* FUNÇÕES DA ABA CHAMADA            */
        /* ---------------------------------- */

        function initializeRoomTabsChamada() {
            const container = document.getElementById('roomTabsCall');
            container.innerHTML = '';
            
            Object.keys(roomsData).forEach(roomKey => {
                const room = roomsData[roomKey];
                const tab = document.createElement('div');
                tab.className = 'room-tab-call';
                tab.innerHTML = `<div class="room-name-tab">${room.icon} ${room.name}</div><div class="room-age-tab">${room.age}</div>`;
                tab.onclick = () => selectRoomChamada(roomKey, tab);
                container.appendChild(tab);
            });
            
            // Define a data atual no input de data
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Mês começa em 0
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('dateInput').value = `${yyyy}-${mm}-${dd}`;
            
            renderEmptyKidsList();
        }
        
        function renderEmptyKidsList() {
            document.getElementById('kidsList').innerHTML = `
                <div class="empty-state">
                    Escolha uma sala para começar a lista de chamada.
                </div>
            `;
            document.getElementById('chamadaTitle').innerHTML = `📝 Chamada - Selecione a Sala Acima`;
        }

        function selectRoomChamada(roomKey, tabElement) {
            document.querySelectorAll('.room-tab-call').forEach(t => t.classList.remove('active'));
            
            tabElement.classList.add('active');
            selectedRoomKeyChamada = roomKey;
            
            const room = roomsData[roomKey];
            document.getElementById('chamadaTitle').innerHTML = `📝 Chamada - ${room.icon} Sala ${room.name}`;
            renderKidsList();
        }
        
        function renderKidsList() {
            const container = document.getElementById('kidsList');
            container.innerHTML = `<div class="form-label">Crianças Presentes (Preencha de 1 a ${MAX_KIDS} nomes):</div>`;
            
            for (let i = 1; i <= MAX_KIDS; i++) {
                const group = document.createElement('div');
                group.className = 'kid-input-group';
                group.innerHTML = `
                    <div class="kid-number">${i}.</div>
                    <input type="text" id="kid-${i}" placeholder="Nome da criança ${i}">
                `;
                container.appendChild(group);
            }
        }
        
        async function submitCall() {

            if (!selectedRoomKeyChamada) {
                alert("Por favor, selecione uma Sala!");
                return;
            }

            const submitBtn = document.querySelector('.btn-submit');
            submitBtn.disabled = true;
            submitBtn.textContent = '⏳ Enviando...';

            const teacherName = document.getElementById('teacherName').value.trim();
            const date = document.getElementById('dateInput').value; // Formato YYYY-MM-DD

            if (!teacherName || !date) {
                alert("Por favor, preencha seu nome e a data da aula!");
                submitBtn.disabled = false;
                submitBtn.textContent = '✅ Finalizar Chamada';
                return;
            }
            
            const room = roomsData[selectedRoomKeyChamada];
            const presentKids = [];

            for (let i = 1; i <= MAX_KIDS; i++) {
                const kidName = document.getElementById(`kid-${i}`).value.trim();
                if (kidName) {
                    presentKids.push(kidName);
                }
            }
            
            const totalPresent = presentKids.length;

            if (totalPresent === 0) {
                alert("Nenhuma criança registrada! Por favor, insira pelo menos um nome.");
                submitBtn.disabled = false;
                submitBtn.textContent = '✅ Finalizar Chamada';
                return;
            }
            
            // Usando URLSearchParams para dados de formulário (formato que o Apps Script prefere)
            const formData = new URLSearchParams();
            formData.append('room_name', room.name);
            formData.append('room_age', room.age);
            formData.append('lesson_date', date);
            formData.append('teacher_name', teacherName);
            formData.append('total_present', totalPresent);
            formData.append('kids_list', presentKids.join('; ')); // Junta em uma string separada por ;

            try {
                const response = await fetch(SHEET_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    body: formData // Envia os dados no formato de formulário
                });

                // A resposta real não é lida devido ao 'no-cors', mas se chegou aqui, a requisição foi enviada.

                alert(`🎉 Chamada da Sala ${room.name} concluída com sucesso! Os ${totalPresent} nomes foram enviados para a planilha.`);

                // Limpar o formulário
                document.getElementById('teacherName').value = '';
                document.querySelectorAll('#tab-chamada .kid-input-group input').forEach(input => input.value = '');

            } catch (error) {
                console.error("Erro ao enviar dados para o Google Sheet:", error);
                alert("❌ Erro ao enviar a chamada. Tente novamente ou verifique a conexão.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '✅ Finalizar Chamada';
            }
        }


        // INICIALIZAÇÃO GERAL
        initializeDateButtons();
        initializeRoomButtons();
        initializeRoomTabsChamada(); // Inicializa os botões da aba Chamada
        renderSchedules();
    </script>
</body>
</html>
