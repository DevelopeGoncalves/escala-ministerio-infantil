<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TELÃO HOLYRICS - V2</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            margin: 0; padding: 0; 
            background-color: #000; 
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; align-items: center; justify-content: center;
            height: 100vh; width: 100vw;
            cursor: none; /* Esconde o mouse para ficar bonito na projeção */
        }

        /* CARD DE AVISO */
        #alert-box {
            display: none; 
            background: linear-gradient(135deg, #b91c1c 0%, #7f1d1d 100%);
            border: 8px solid #fff;
            border-radius: 60px;
            padding: 40px;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 0 200px rgba(220, 38, 38, 0.8);
            text-align: center;
            color: white;
            position: relative;
            z-index: 10;
        }

        /* Animação de Entrada e Saída */
        .fade-in { animation: zoomIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .fade-out { animation: zoomOut 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        @keyframes zoomIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes zoomOut {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0; }
        }

        .alert-header {
            font-size: 3.5rem; font-weight: 900; text-transform: uppercase;
            margin-bottom: 30px; text-shadow: 4px 4px 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; gap: 20px;
            color: #fef2f2;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            padding-bottom: 20px;
        }

        .alert-content {
            display: flex; align-items: center; justify-content: center; gap: 60px;
        }

        .kid-photo {
            width: 380px; height: 380px;
            border-radius: 50%; border: 15px solid white;
            object-fit: cover;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            background: #fff;
        }

        .alert-text { text-align: left; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        
        .alert-label { 
            font-size: 1.8rem; text-transform: uppercase; 
            opacity: 0.9; margin-bottom: 10px; font-weight: 600; letter-spacing: 1px;
        }
        
        .kid-name { 
            font-size: 5rem; font-weight: 800; line-height: 1.1; 
            margin-bottom: 25px; text-shadow: 3px 3px 15px rgba(0,0,0,0.6); color: #fff; 
        }
        
        .room-badge { 
            background: white; color: #991b1b; 
            padding: 10px 40px; border-radius: 80px; 
            font-size: 2.5rem; font-weight: 900; display: inline-block;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            align-self: flex-start;
        }

        /* Indicador de Fila (se tiver mais gente esperando) */
        #queue-indicator {
            position: absolute; bottom: 20px; right: 40px;
            font-size: 1.5rem; color: rgba(255,255,255,0.7);
            font-weight: bold; display: none;
        }

        /* Debug de imagem (opcional, só aparece se der erro) */
        .img-error-msg { font-size: 1rem; color: yellow; margin-top: 10px; display: none; }
    </style>
</head>
<body onclick="enableAudioContext()"> <div id="alert-box">
        <div class="alert-header">
            <i class="fas fa-exclamation-circle"></i> Atenção Pais
        </div>
        <div class="alert-content">
            <div>
                <img id="photo" class="kid-photo" src="" alt="Foto">
                <div id="img-debug" class="img-error-msg">Erro na Imagem</div>
            </div>
            <div class="alert-text">
                <div class="alert-label">Favor comparecer à:</div>
                <div class="room-badge" id="room">SALA</div>
                <div class="alert-label" style="margin-top:20px;">Responsável por:</div>
                <div class="kid-name" id="name">NOME</div>
            </div>
        </div>
        <div id="queue-indicator"><i class="fas fa-layer-group"></i> +<span id="queue-count">0</span> na fila</div>
    </div>

    <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // CONFIGURAÇÃO
        const TEMPO_EXIBICAO = 7000; // Tempo que cada aviso fica na tela (7 segundos)

        const firebaseConfig = {
            apiKey: "AIzaSyBI5S5ciZioheWabi0W0Ii_r0e3RsYm3iw",
            authDomain: "cadastro-final-cc77f.firebaseapp.com",
            databaseURL: "https://cadastro-final-cc77f-default-rtdb.firebaseio.com",
            projectId: "cadastro-final-cc77f",
            storageBucket: "cadastro-final-cc77f.firebasestorage.app",
            messagingSenderId: "229086987694",
            appId: "1:229086987694:web:52f1a32f4b1a9f5be2743f",
            measurementId: "G-9F9WBCMH6Y"
        };
        
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        let audioCtxEnabled = false;
        const synth = window.speechSynthesis;
        
        // SISTEMA DE FILA
        let alertQueue = [];
        let isShowing = false;
        let processedKeys = new Set(); // Para não repetir avisos antigos

        // 1. Ativa áudio no primeiro clique (Regra do Navegador)
        function enableAudioContext() {
            if(audioCtxEnabled) return;
            const audio = document.getElementById('alertSound');
            audio.volume = 0; 
            audio.play().then(() => {
                audio.pause(); audio.currentTime = 0; audio.volume = 1;
                audioCtxEnabled = true;
                // Carrega vozes
                if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = getVoices;
                getVoices();
            }).catch(e => console.log("Aguardando clique..."));
        }

        // 2. Ouvinte do Firebase
        db.ref('chamados').on('child_added', (snapshot) => {
            const data = snapshot.val();
            const key = snapshot.key;
            
            // Verifica se é recente (últimos 5 minutos) para não carregar lixo antigo
            const now = new Date().getTime();
            if (data.timestamp && (now - data.timestamp < 300000)) {
                if(!processedKeys.has(key)) {
                    processedKeys.add(key);
                    enqueueAlert(data);
                }
            }
        });

        // 3. Gerenciamento da Fila
        function enqueueAlert(data) {
            alertQueue.push(data);
            updateQueueIndicator();
            processQueue();
        }

        function processQueue() {
            if(isShowing || alertQueue.length === 0) return;

            isShowing = true;
            const current = alertQueue.shift(); // Pega o primeiro da fila
            updateQueueIndicator();
            
            displayAlert(current);
        }

        function updateQueueIndicator() {
            const el = document.getElementById('queue-indicator');
            const countEl = document.getElementById('queue-count');
            if(alertQueue.length > 0) {
                el.style.display = 'block';
                countEl.innerText = alertQueue.length;
            } else {
                el.style.display = 'none';
            }
        }

        // 4. Exibição
        function displayAlert(data) {
            const box = document.getElementById('alert-box');
            
            // Preenche textos
            document.getElementById('name').innerText = data.kidName;
            document.getElementById('room').innerText = data.roomName;
            
            // Lógica da Imagem (Tenta corrigir caminhos)
            const imgEl = document.getElementById('photo');
            const debugEl = document.getElementById('img-debug');
            debugEl.style.display = 'none';

            let src = data.photoUrl;
            
            // Se não for link da web (http), assume arquivo local
            if (!src.startsWith('http') && !src.startsWith('data:')) {
                // Remove qualquer "img/" que já exista pra não duplicar (ex: img/img/foto.png)
                let cleanName = src.replace('img/', '');
                
                // Tenta caminho padrão: pasta 'img' ao lado do arquivo
                src = 'img/' + cleanName;
            }

            imgEl.onload = () => { debugEl.style.display = 'none'; };
            imgEl.onerror = () => { 
                console.log("Erro ao carregar imagem, tentando raiz...");
                // Se falhar "img/foto.png", tenta só "foto.png" (caso esteja tudo misturado)
                if(src.includes('img/')) {
                    imgEl.src = src.replace('img/', '');
                } else {
                    // Se falhar tudo, põe avatar genérico
                    imgEl.src = `https://ui-avatars.com/api/?name=${data.kidName}&background=random&size=300&font-size=0.33`;
                    debugEl.innerText = "Imagem não encontrada";
                    debugEl.style.display = 'block';
                }
                // Evita loop infinito de erro
                imgEl.onerror = null;
            };
            imgEl.src = src;

            // Animação de Entrada
            box.classList.remove('fade-out');
            box.classList.add('fade-in');
            box.style.display = 'block';

            // Som e Fala
            playAlertSound(data.kidName, data.roomName);

            // Agenda a saída
            setTimeout(() => {
                closeAlert();
            }, TEMPO_EXIBICAO);
        }

        function closeAlert() {
            const box = document.getElementById('alert-box');
            box.classList.remove('fade-in');
            box.classList.add('fade-out');

            setTimeout(() => {
                box.style.display = 'none';
                isShowing = false;
                processQueue(); // Chama o próximo da fila se houver
            }, 600); // Tempo da animação de saída
        }

        // 5. Áudio
        function getVoices() {
            const voices = synth.getVoices();
            return voices.find(v => v.name.includes('Google') && v.lang.includes('pt-BR')) || voices[0];
        }

        function playAlertSound(name, room) {
            // Toca beep
            const audio = document.getElementById('alertSound');
            if(audioCtxEnabled) {
                audio.play().catch(e => console.log("Áudio bloqueado. Clique na tela."));
                
                // Fala TTS após o beep
                setTimeout(() => {
                    synth.cancel();
                    const text = `Atenção pais. Solicitamos a presença do responsável por ${name}, na sala ${room}.`;
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.voice = getVoices();
                    utterance.lang = 'pt-BR';
                    synth.speak(utterance);
                }, 1500);
            }
        }

        // CONTROLE DE TECLADO (OPCIONAL)
        // Espaço = Pula para o próximo imediatamente
        // Esc = Limpa a tela
        document.addEventListener('keydown', (e) => {
            if(e.code === 'Space' && isShowing) {
                // Força fechar o atual e ir pro próximo
                closeAlert();
            }
        });

    </script>
</body>
</html>